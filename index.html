<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Arvin&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Arvin&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Arvin&#39;s Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Arvin&#39;s Blog">
  
    <link rel="alternate" href="/atom.xml" title="Arvin&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Arvin&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-MongoDB-Knowledge-Point-For-Developers" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/10/MongoDB-Knowledge-Point-For-Developers/" class="article-date">
  <time datetime="2018-08-10T08:46:32.000Z" itemprop="datePublished">2018-08-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/10/MongoDB-Knowledge-Point-For-Developers/">MongoDB Knowledge Point For Developers</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>转载请标明出处</strong><br><!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} --></p>
<!-- code_chunk_output -->
<ul>
<li><a href="#mongodb-knowledge-point-for-developers">MongoDB Knowledge Point For Developers</a><ul>
<li><a href="#1-基础概念">1. 基础概念</a><ul>
<li><a href="#11-database">1.1 database</a></li>
<li><a href="#12-collection">1.2 collection</a></li>
<li><a href="#13-document">1.3 document</a><ul>
<li><a href="#131-数据校验">1.3.1 数据校验</a></li>
<li><a href="#132-文档格式">1.3.2 文档格式</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-基本的crud方法">2. 基本的CRUD方法</a><ul>
<li><a href="#21-插入数据">2.1 插入数据</a><ul>
<li><a href="#211-单条插入">2.1.1 单条插入</a></li>
<li><a href="#212-多条插入">2.1.2 多条插入</a></li>
<li><a href="#213-废弃的插入方法">2.1.3 废弃的插入方法</a></li>
</ul>
</li>
<li><a href="#22-查询数据">2.2 查询数据</a><ul>
<li><a href="#221-基本查询操作">2.2.1 基本查询操作</a><ul>
<li><a href="#2211-查询所有数据">2.2.1.1 查询所有数据</a></li>
<li><a href="#2212-等价条件查询">2.2.1.2 等价条件查询</a></li>
<li><a href="#2213-复合条件查询使用查询操作符查询">2.2.1.3 复合条件查询（使用查询操作符查询）</a></li>
</ul>
</li>
<li><a href="#222-查询操作符">2.2.2 查询操作符</a></li>
<li><a href="#223-嵌套文档查询">2.2.3 嵌套文档查询</a></li>
<li><a href="#224-数组类型查询">2.2.4 数组类型查询</a></li>
<li><a href="#225-数组内的嵌套文档查询">2.2.5 数组内的嵌套文档查询</a></li>
<li><a href="#226-指定查询结果返回的field">2.2.6 指定查询结果返回的field</a></li>
<li><a href="#227-查询空值和field是否存在">2.2.7 查询空值和field是否存在</a></li>
</ul>
</li>
<li><a href="#23-更新数据">2.3 更新数据</a><ul>
<li><a href="#231-更新单个文档">2.3.1 更新单个文档</a></li>
<li><a href="#232-更新多个文档">2.3.2 更新多个文档</a></li>
<li><a href="#233-替换文档">2.3.3 替换文档</a></li>
<li><a href="#234-upsert选项">2.3.4 upsert选项</a></li>
</ul>
</li>
<li><a href="#24-删除数据">2.4 删除数据</a></li>
<li><a href="#25-批量写入">2.5 批量写入</a></li>
</ul>
</li>
<li><a href="#3-数据模型">3. 数据模型</a><ul>
<li><a href="#31-基础知识">3.1 基础知识</a><ul>
<li><a href="#311-灵活的模式">3.1.1 灵活的模式</a></li>
<li><a href="#312-文档结构">3.1.2 文档结构</a></li>
<li><a href="#313-原子性的写入操作">3.1.3 原子性的写入操作</a></li>
<li><a href="#314-数据模型校验">3.1.4 数据模型校验</a></li>
</ul>
</li>
<li><a href="#32-模型设计原则">3.2 模型设计原则</a><ul>
<li><a href="#321-设计原则概述">3.2.1 设计原则概述</a><ul>
<li><a href="#3211-选择嵌套式文档结构">3.2.1.1 选择嵌套式文档结构</a></li>
<li><a href="#3212-选择引用式文档结构">3.2.1.2 选择引用式文档结构</a></li>
<li><a href="#3213-模型设计中的其他考虑因素">3.2.1.3 模型设计中的其他考虑因素</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-索引">4. 索引</a><ul>
<li><a href="#41-索引类型">4.1 索引类型</a><ul>
<li><a href="#411-单字段索引">4.1.1 单字段索引</a></li>
<li><a href="#412-复合索引">4.1.2 复合索引</a></li>
<li><a href="#413-多key索引">4.1.3 多key索引</a></li>
</ul>
</li>
<li><a href="#42-索引属性">4.2 索引属性</a><ul>
<li><a href="#421-唯一索引">4.2.1 唯一索引</a></li>
<li><a href="#422-ttl索引">4.2.2 TTL索引</a></li>
<li><a href="#423-部分索引">4.2.3 部分索引</a></li>
<li><a href="#424-稀疏索引">4.2.4 稀疏索引</a></li>
</ul>
</li>
<li><a href="#43-索引使用注意事项">4.3 索引使用注意事项</a><ul>
<li><a href="#431-创建索引">4.3.1 创建索引</a></li>
<li><a href="#432-选择合适的索引">4.3.2 选择合适的索引</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /code_chunk_output -->
<h1 id="MongoDB-Knowledge-Point-For-Developers"><a href="#MongoDB-Knowledge-Point-For-Developers" class="headerlink" title="MongoDB Knowledge Point For Developers"></a>MongoDB Knowledge Point For Developers</h1><h2 id="1-基础概念"><a href="#1-基础概念" class="headerlink" title="1. 基础概念"></a>1. 基础概念</h2><h3 id="1-1-database"><a href="#1-1-database" class="headerlink" title="1.1 database"></a>1.1 database</h3><p>数据库，一个数据仓库可以包含多个集合</p>
<h3 id="1-2-collection"><a href="#1-2-collection" class="headerlink" title="1.2 collection"></a>1.2 collection</h3><p>集合，类似于关系数据库中的表。一个集合可以包含多个文档。</p>
<p>capped collection（限制集合）：设定空间上线，循环写入，新数据覆盖旧数据</p>
<h3 id="1-3-document"><a href="#1-3-document" class="headerlink" title="1.3 document"></a>1.3 document</h3><p>文档，一个文档保存着一份数据记录。</p>
<h4 id="1-3-1-数据校验"><a href="#1-3-1-数据校验" class="headerlink" title="1.3.1 数据校验"></a>1.3.1 数据校验</h4><p>一个集合下的文档，不会默认要求它们具有相同的数据模式。也就是说，同一个集合下的多个文档：1.字段可以不同；2.同名字段的类型可以不同；相反，如果对文档数据类型有要求，可以在创建集合时设置validator（例如使用JSON schema）来限制集合下文档的数据类别。</p>
<h4 id="1-3-2-文档格式"><a href="#1-3-2-文档格式" class="headerlink" title="1.3.2 文档格式"></a>1.3.2 文档格式</h4><p>文档使用BSON来存储，BSON是JSON的二进制表现形式，因此可以适应更多的数据类型。<br>存储在文档的数据格式，与JSON类似，以键值对的形式存储。<br>默认主键_id，为ObjectId类型。</p>
<h2 id="2-基本的CRUD方法"><a href="#2-基本的CRUD方法" class="headerlink" title="2. 基本的CRUD方法"></a>2. 基本的CRUD方法</h2><h3 id="2-1-插入数据"><a href="#2-1-插入数据" class="headerlink" title="2.1 插入数据"></a>2.1 插入数据</h3><h4 id="2-1-1-单条插入"><a href="#2-1-1-单条插入" class="headerlink" title="2.1.1 单条插入"></a>2.1.1 单条插入</h4><p>使用<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.insert_one" target="_blank" rel="noopener">insert_one()</a>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">book = &#123;</span><br><span class="line">	<span class="string">'name'</span>: <span class="string">'computer_science'</span>,</span><br><span class="line">	<span class="string">'page'</span>: <span class="number">238</span>,</span><br><span class="line">&#125;</span><br><span class="line">result = db.books.insert_one(book)</span><br><span class="line">_id = result.inserted_id	<span class="comment"># 返回插入项的id，类型为ObjectId</span></span><br></pre></td></tr></table></figure>
<h4 id="2-1-2-多条插入"><a href="#2-1-2-多条插入" class="headerlink" title="2.1.2 多条插入"></a>2.1.2 多条插入</h4><p>使用<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.insert_many" target="_blank" rel="noopener">insert_many()</a>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">results = db.collection_name.insert_many([document1, document2, ...])</span><br><span class="line">id_list = results.inserted_ids	<span class="comment"># 返回插入项的id列表，列表元素为ObjectId</span></span><br></pre></td></tr></table></figure>
<h4 id="2-1-3-废弃的插入方法"><a href="#2-1-3-废弃的插入方法" class="headerlink" title="2.1.3 废弃的插入方法"></a>2.1.3 废弃的插入方法</h4><p>从pymongo3.0版本开始，已经不推荐使用<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.insert" target="_blank" rel="noopener">insert()</a>方法插入数据，虽然它能同时满足单条或多条数据的处理需求。<br>官方建议使用insert_one()和insert_many()来执行替代操作</p>
<h3 id="2-2-查询数据"><a href="#2-2-查询数据" class="headerlink" title="2.2 查询数据"></a>2.2 查询数据</h3><p>假设预先执行了数据插入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.insert_many([</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"journal"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">25</span>,</span><br><span class="line">     <span class="string">"size"</span>: &#123;<span class="string">"h"</span>: <span class="number">14</span>, <span class="string">"w"</span>: <span class="number">21</span>, <span class="string">"uom"</span>: <span class="string">"cm"</span>&#125;,</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"A"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"notebook"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">50</span>,</span><br><span class="line">     <span class="string">"size"</span>: &#123;<span class="string">"h"</span>: <span class="number">8.5</span>, <span class="string">"w"</span>: <span class="number">11</span>, <span class="string">"uom"</span>: <span class="string">"in"</span>&#125;,</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"A"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"paper"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">100</span>,</span><br><span class="line">     <span class="string">"size"</span>: &#123;<span class="string">"h"</span>: <span class="number">8.5</span>, <span class="string">"w"</span>: <span class="number">11</span>, <span class="string">"uom"</span>: <span class="string">"in"</span>&#125;,</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"D"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"planner"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">75</span>, <span class="string">"size"</span>: &#123;<span class="string">"h"</span>: <span class="number">22.85</span>, <span class="string">"w"</span>: <span class="number">30</span>, <span class="string">"uom"</span>: <span class="string">"cm"</span>&#125;,</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"D"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"postcard"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">45</span>,</span><br><span class="line">     <span class="string">"size"</span>: &#123;<span class="string">"h"</span>: <span class="number">10</span>, <span class="string">"w"</span>: <span class="number">15.25</span>, <span class="string">"uom"</span>: <span class="string">"cm"</span>&#125;,</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"A"</span>&#125;])</span><br></pre></td></tr></table></figure>
<h4 id="2-2-1-基本查询操作"><a href="#2-2-1-基本查询操作" class="headerlink" title="2.2.1 基本查询操作"></a>2.2.1 基本查询操作</h4><h5 id="2-2-1-1-查询所有数据"><a href="#2-2-1-1-查询所有数据" class="headerlink" title="2.2.1.1 查询所有数据"></a>2.2.1.1 查询所有数据</h5><p>使用<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.find" target="_blank" rel="noopener">find()</a>方法执行查询，返回游标<a href="https://api.mongodb.com/python/current/api/pymongo/cursor.html#pymongo.cursor.Cursor" target="_blank" rel="noopener">cursor</a><br>查询所有记录时，find()内的filter参数为空</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>上述查询，类似于关系数据库SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> inventory</span><br></pre></td></tr></table></figure>
<h5 id="2-2-1-2-等价条件查询"><a href="#2-2-1-2-等价条件查询" class="headerlink" title="2.2.1.2 等价条件查询"></a>2.2.1.2 等价条件查询</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;<span class="string">"status"</span>: <span class="string">"D"</span>&#125;)</span><br></pre></td></tr></table></figure>
<p>上述查询语句，类似于关系数据库SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> inventory <span class="keyword">WHERE</span> <span class="keyword">status</span> = <span class="string">"D"</span></span><br></pre></td></tr></table></figure>
<h5 id="2-2-1-3-复合条件查询（使用查询操作符查询）"><a href="#2-2-1-3-复合条件查询（使用查询操作符查询）" class="headerlink" title="2.2.1.3 复合条件查询（使用查询操作符查询）"></a>2.2.1.3 复合条件查询（使用查询操作符查询）</h5><ol>
<li><strong>包含(IN)关系查询</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;<span class="string">"status"</span>: &#123;<span class="string">"$in"</span>: [<span class="string">"A"</span>, <span class="string">"D"</span>]&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>上述查询语句，类似于关系数据库SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> inventory <span class="keyword">WHERE</span> <span class="keyword">status</span> <span class="keyword">in</span> (<span class="string">"A"</span>, <span class="string">"D"</span>)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><strong>与(AND)关系查询</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;<span class="string">"status"</span>: <span class="string">"A"</span>, <span class="string">"qty"</span>: &#123;<span class="string">"$lt"</span>: <span class="number">30</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>上述查询语句，类似于关系数据库SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> inventory <span class="keyword">WHERE</span> <span class="keyword">status</span> = <span class="string">"A"</span> <span class="keyword">AND</span> qty &lt; <span class="number">30</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>或(OR)关系查询</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;<span class="string">"$or"</span>: [&#123;<span class="string">"status"</span>: <span class="string">"A"</span>&#125;, &#123;<span class="string">"qty"</span>: &#123;<span class="string">"$lt"</span>: <span class="number">30</span>&#125;&#125;]&#125;)</span><br></pre></td></tr></table></figure>
<p>上述查询语句，类似于关系数据库SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> inventory <span class="keyword">WHERE</span> <span class="keyword">status</span> = <span class="string">"A"</span> <span class="keyword">OR</span> qty &lt; <span class="number">30</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li><strong>在查询中同时使用AND和OR</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;</span><br><span class="line">    <span class="string">"status"</span>: <span class="string">"A"</span>,</span><br><span class="line">    <span class="string">"$or"</span>: [&#123;<span class="string">"qty"</span>: &#123;<span class="string">"$lt"</span>: <span class="number">30</span>&#125;&#125;, &#123;<span class="string">"item"</span>: &#123;<span class="string">"$regex"</span>: <span class="string">"^p"</span>&#125;&#125;]&#125;)</span><br></pre></td></tr></table></figure>
<p>上述查询语句，类似于关系数据库SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> inventory <span class="keyword">WHERE</span> <span class="keyword">status</span> = <span class="string">"A"</span> <span class="keyword">AND</span> ( qty &lt; <span class="number">30</span> <span class="keyword">OR</span> item <span class="keyword">LIKE</span> <span class="string">"p%"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="2-2-2-查询操作符"><a href="#2-2-2-查询操作符" class="headerlink" title="2.2.2 查询操作符"></a>2.2.2 查询操作符</h4><p>查询操作符定义了查询条件，如：大于、等于、小于等，以下是整理的查询操作符及说明：</p>
<table>
<thead>
<tr>
<th>比较操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$eq</td>
<td>等于</td>
</tr>
<tr>
<td>$gt</td>
<td>大于</td>
</tr>
<tr>
<td>$gte</td>
<td>大于等于</td>
</tr>
<tr>
<td>$in</td>
<td>包含</td>
</tr>
<tr>
<td>$lt</td>
<td>小于</td>
</tr>
<tr>
<td>$lte</td>
<td>小于等于</td>
</tr>
<tr>
<td>$ne</td>
<td>不等于</td>
</tr>
<tr>
<td>$nin</td>
<td>不包含于</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>逻辑操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$and</td>
<td>与</td>
</tr>
<tr>
<td>$not</td>
<td>非</td>
</tr>
<tr>
<td>$nor</td>
<td>或非</td>
</tr>
<tr>
<td>$or</td>
<td>或</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>元素操作符</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$exists</td>
<td>指定field存在</td>
</tr>
<tr>
<td>$type</td>
<td>指定field的type</td>
</tr>
</tbody>
</table>
<p>查看field的<a href="https://docs.mongodb.com/manual/reference/operator/query/type/#document-type-available-types" target="_blank" rel="noopener">type类型说明</a></p>
<p>其他操作符说明请见：<a href="https://docs.mongodb.com/manual/reference/operator/query/#query-selectors" target="_blank" rel="noopener">Query and Projection Operators</a></p>
<h4 id="2-2-3-嵌套文档查询"><a href="#2-2-3-嵌套文档查询" class="headerlink" title="2.2.3 嵌套文档查询"></a>2.2.3 嵌套文档查询</h4><p>对于文档中存在的嵌套结构的查询,可以对文档中的嵌套结构进行 <strong>匹配查询</strong> ，也可以对嵌套内容中的某个字段进行 <strong>嵌套字段查询</strong></p>
<p>假设文档数据如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bson.son <span class="keyword">import</span> SON</span><br><span class="line">db.inventory.insert_many([</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"journal"</span>, <span class="comment"># 物品名称</span></span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">25</span>,	<span class="comment"># 数量</span></span><br><span class="line">     <span class="string">"size"</span>: SON([(<span class="string">"h"</span>, <span class="number">14</span>), (<span class="string">"w"</span>, <span class="number">21</span>), (<span class="string">"uom"</span>, <span class="string">"cm"</span>)]), <span class="comment"># 嵌套结构（高度，宽度，度量单位）</span></span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"A"</span>&#125;, <span class="comment"># 状态</span></span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"notebook"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">50</span>,</span><br><span class="line">     <span class="string">"size"</span>: SON([(<span class="string">"h"</span>, <span class="number">8.5</span>), (<span class="string">"w"</span>, <span class="number">11</span>), (<span class="string">"uom"</span>, <span class="string">"in"</span>)]),</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"A"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"paper"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">100</span>,</span><br><span class="line">     <span class="string">"size"</span>: SON([(<span class="string">"h"</span>, <span class="number">8.5</span>), (<span class="string">"w"</span>, <span class="number">11</span>), (<span class="string">"uom"</span>, <span class="string">"in"</span>)]),</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"D"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"planner"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">75</span>,</span><br><span class="line">     <span class="string">"size"</span>: SON([(<span class="string">"h"</span>, <span class="number">22.85</span>), (<span class="string">"w"</span>, <span class="number">30</span>), (<span class="string">"uom"</span>, <span class="string">"cm"</span>)]),</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"D"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"postcard"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">45</span>,</span><br><span class="line">     <span class="string">"size"</span>: SON([(<span class="string">"h"</span>, <span class="number">10</span>), (<span class="string">"w"</span>, <span class="number">15.25</span>), (<span class="string">"uom"</span>, <span class="string">"cm"</span>)]),</span><br><span class="line">     <span class="string">"status"</span>: <span class="string">"A"</span>&#125;])</span><br></pre></td></tr></table></figure>
<ol>
<li>对嵌套结构进行匹配查询</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bson.son <span class="keyword">import</span> SON</span><br><span class="line">cursor = db.inventory.find(</span><br><span class="line">    &#123;<span class="string">"size"</span>: SON([(<span class="string">"h"</span>, <span class="number">14</span>), (<span class="string">"w"</span>, <span class="number">21</span>), (<span class="string">"uom"</span>, <span class="string">"cm"</span>)])&#125;)</span><br><span class="line"><span class="comment"># 上述查询语句中的filter条件，需要完全匹配嵌套文档中的内容，否则无法查询到相关记录。</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>对嵌套结构中的字段进行查询</li>
</ol>
<p>mongo使用点表示法指定文档中的嵌套字段：”field.nested_field”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询嵌套字段uom的值为cm的记录</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">"size.uom"</span>: <span class="string">"cm"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用操作符查询高度大于10的记录</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">"size.h"</span>: &#123;<span class="string">"$gt"</span>: <span class="number">10</span>&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个字段的复合查询</span></span><br><span class="line">cursor = db.inventory.find(</span><br><span class="line">    &#123;<span class="string">"size.h"</span>: &#123;<span class="string">"$lt"</span>: <span class="number">15</span>&#125;, <span class="string">"size.uom"</span>: <span class="string">"in"</span>, <span class="string">"status"</span>: <span class="string">"D"</span>&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="2-2-4-数组类型查询"><a href="#2-2-4-数组类型查询" class="headerlink" title="2.2.4 数组类型查询"></a>2.2.4 数组类型查询</h4><p>假设向collection中插入如下数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.insert_many([</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"journal"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">25</span>,</span><br><span class="line">     <span class="string">"tags"</span>: [<span class="string">"blank"</span>, <span class="string">"red"</span>],</span><br><span class="line">     <span class="string">"dim_cm"</span>: [<span class="number">14</span>, <span class="number">21</span>]&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"notebook"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">50</span>,</span><br><span class="line">     <span class="string">"tags"</span>: [<span class="string">"red"</span>, <span class="string">"blank"</span>],</span><br><span class="line">     <span class="string">"dim_cm"</span>: [<span class="number">14</span>, <span class="number">21</span>]&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"paper"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">100</span>,</span><br><span class="line">     <span class="string">"tags"</span>: [<span class="string">"red"</span>, <span class="string">"blank"</span>, <span class="string">"plain"</span>],</span><br><span class="line">     <span class="string">"dim_cm"</span>: [<span class="number">14</span>, <span class="number">21</span>]&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"planner"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">75</span>,</span><br><span class="line">     <span class="string">"tags"</span>: [<span class="string">"blank"</span>, <span class="string">"red"</span>],</span><br><span class="line">     <span class="string">"dim_cm"</span>: [<span class="number">22.85</span>, <span class="number">30</span>]&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"postcard"</span>,</span><br><span class="line">     <span class="string">"qty"</span>: <span class="number">45</span>,</span><br><span class="line">     <span class="string">"tags"</span>: [<span class="string">"blue"</span>],</span><br><span class="line">     <span class="string">"dim_cm"</span>: [<span class="number">10</span>, <span class="number">15.25</span>]&#125;])</span><br></pre></td></tr></table></figure>
<p>与2.2.3中嵌套文档查询类似，可以对整个数组进行 <strong>匹配查询</strong> ， 也可以对数组中的某个元素进行查询</p>
<ol>
<li>匹配整个数组</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;<span class="string">"tags"</span>: [<span class="string">"red"</span>, <span class="string">"blank"</span>]&#125;)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>查询数组中的某个元素</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有tags中包含red元素的数组都会被查询到</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">"tags"</span>: <span class="string">"red"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对数组中某个元素进行条件查询</span></span><br><span class="line"><span class="comment"># dim_cm中任意一个元素大于25的记录查询</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">"dim_cm"</span>: &#123;<span class="string">"$gt"</span>: <span class="number">25</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>数组元素的复合条件查询</li>
</ol>
<p>查询dim_cm中的某个元素能同时满足大于15小于20的查询条件的记录<br><strong>或者</strong> dim_cm中的一个元素大于15，并且存在另一个元素小于20的记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  这种查询是不限制单个数组元素的，多个数组元素分别满足查询条件亦可</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">"dim_cm"</span>: &#123;<span class="string">"$gt"</span>: <span class="number">15</span>, <span class="string">"$lt"</span>: <span class="number">20</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p>若要指定数组中某一个元素满足多个查询条件，需要使用 <strong>$elemMatch</strong>操作符来进行查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询数组中存在某一个元素同时满足大于22并且小于30</span></span><br><span class="line">cursor = db.inventory.find(</span><br><span class="line">    &#123;<span class="string">"dim_cm"</span>: &#123;<span class="string">"$elemMatch"</span>: &#123;<span class="string">"$gt"</span>: <span class="number">22</span>, <span class="string">"$lt"</span>: <span class="number">30</span>&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>根据数组索引位置查询</li>
</ol>
<p>查询dim_cm的第一个元素大于25的记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;<span class="string">"dim_cm.1"</span>: &#123;<span class="string">"$gt"</span>: <span class="number">25</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>根据数组长度查询</li>
</ol>
<p>查询数组长度是否符合查询条件，需要使用 <strong>$size</strong> 操作符<br>查询所有tags长度等于3的的记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;<span class="string">"tags"</span>: &#123;<span class="string">"$size"</span>: <span class="number">3</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="2-2-5-数组内的嵌套文档查询"><a href="#2-2-5-数组内的嵌套文档查询" class="headerlink" title="2.2.5 数组内的嵌套文档查询"></a>2.2.5 数组内的嵌套文档查询</h4><p>假设向collection中插入如下数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bson.son <span class="keyword">import</span> SON</span><br><span class="line">db.inventory.insert_many([</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"journal"</span>,</span><br><span class="line">     <span class="string">"instock"</span>: [</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"A"</span>), (<span class="string">"qty"</span>, <span class="number">5</span>)]),</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"C"</span>), (<span class="string">"qty"</span>, <span class="number">15</span>)])]&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"notebook"</span>,</span><br><span class="line">     <span class="string">"instock"</span>: [</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"C"</span>), (<span class="string">"qty"</span>, <span class="number">5</span>)])]&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"paper"</span>,</span><br><span class="line">     <span class="string">"instock"</span>: [</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"A"</span>), (<span class="string">"qty"</span>, <span class="number">60</span>)]),</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"B"</span>), (<span class="string">"qty"</span>, <span class="number">15</span>)])]&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"planner"</span>,</span><br><span class="line">     <span class="string">"instock"</span>: [</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"A"</span>), (<span class="string">"qty"</span>, <span class="number">40</span>)]),</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"B"</span>), (<span class="string">"qty"</span>, <span class="number">5</span>)])]&#125;,</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"postcard"</span>,</span><br><span class="line">     <span class="string">"instock"</span>: [</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"B"</span>), (<span class="string">"qty"</span>, <span class="number">15</span>)]),</span><br><span class="line">         SON([(<span class="string">"warehouse"</span>, <span class="string">"C"</span>), (<span class="string">"qty"</span>, <span class="number">35</span>)])]&#125;])</span><br></pre></td></tr></table></figure>
<p>可以看到instock数组内部每一个元素都是一个嵌套文档。对这类数据的查询方法，是2.2.3嵌套文档查询和2.2.4数组类型查询的结合。</p>
<ol>
<li>对数组内某个嵌套文档进行 <strong>匹配查询</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配查询对于嵌套文档内的field顺序有要求，</span></span><br><span class="line"><span class="comment"># 查询结果只展示与查询条件中field排列顺序相同的记录。</span></span><br><span class="line">cursor = db.inventory.find(</span><br><span class="line">    &#123;<span class="string">"instock"</span>: SON([(<span class="string">"warehouse"</span>, <span class="string">"A"</span>), (<span class="string">"qty"</span>, <span class="number">5</span>)])&#125;)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>对数组内的嵌套文档字段进行 <strong>条件查询</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有文档中，instock数组中至少有一个元素的qty值大于20的记录</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">'instock.qty'</span>: &#123;<span class="string">"$lte"</span>: <span class="number">20</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>对数组形式的嵌套文档按照 <strong>数组索引查询</strong></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有文档中，instock数组的第0个嵌套文档元素中，qty的值小于等于20的所有记录</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">'instock.0.qty'</span>: &#123;<span class="string">"$lte"</span>: <span class="number">20</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>使用 <strong>$elemMatch</strong> 对数组内的某个嵌套文档进行复合查询</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数组内的某个文档同时满足qty=5并且warehouse值为A的查询条件</span></span><br><span class="line">cursor = db.inventory.find(</span><br><span class="line">    &#123;<span class="string">"instock"</span>: &#123;<span class="string">"$elemMatch"</span>: &#123;<span class="string">"qty"</span>: <span class="number">5</span>, <span class="string">"warehouse"</span>: <span class="string">"A"</span>&#125;&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数组内的某个文档的qty值大于10并且小于等于20</span></span><br><span class="line">cursor = db.inventory.find(</span><br><span class="line">    &#123;<span class="string">"instock"</span>: &#123;<span class="string">"$elemMatch"</span>: &#123;<span class="string">"qty"</span>: &#123;<span class="string">"$gt"</span>: <span class="number">10</span>, <span class="string">"$lte"</span>: <span class="number">20</span>&#125;&#125;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="2-2-6-指定查询结果返回的field"><a href="#2-2-6-指定查询结果返回的field" class="headerlink" title="2.2.6 指定查询结果返回的field"></a>2.2.6 指定查询结果返回的field</h4><p>MonogDB返回的查询结果，默认包含文档中所有的field，使用者可以通过让mongo返回指定的field，来限制返回内容的数量。</p>
<p>查询表达式如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回指定的field</span></span><br><span class="line">cursor = db.inventory.find(</span><br><span class="line">    &#123;<span class="string">"status"</span>: <span class="string">"A"</span>&#125;, &#123;<span class="string">"item"</span>: <span class="number">1</span>, <span class="string">"status"</span>: <span class="number">1</span>, <span class="string">"size.uom"</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不返回指定的field</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">"status"</span>: <span class="string">"A"</span>&#125;, &#123;<span class="string">"size.uom"</span>: <span class="number">0</span>, <span class="string">"status"</span>: <span class="number">0</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对于数组形式的field，指定只返回最后一个元素（使用$slice操作符）</span></span><br><span class="line">cursor = db.inventory.find(</span><br><span class="line">    &#123;<span class="string">"status"</span>: <span class="string">"A"</span>&#125;,</span><br><span class="line">    &#123;<span class="string">"instock"</span>: &#123;<span class="string">"$slice"</span>: <span class="number">-1</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="2-2-7-查询空值和field是否存在"><a href="#2-2-7-查询空值和field是否存在" class="headerlink" title="2.2.7 查询空值和field是否存在"></a>2.2.7 查询空值和field是否存在</h4><ol>
<li>查询item为空或item字段不存在</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cursor = db.inventory.find(&#123;<span class="string">"item"</span>: <span class="keyword">None</span>&#125;)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>只查询字段为空的记录<br> type值<a href="https://docs.mongodb.com/manual/reference/bson-types/" target="_blank" rel="noopener">参照</a></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># type值为10时表示的是null类型</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">"item"</span>: &#123;<span class="string">"$type"</span>: <span class="number">10</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>查询某字段不存在</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有文档中，没有item字段的记录</span></span><br><span class="line">cursor = db.inventory.find(&#123;<span class="string">"item"</span>: &#123;<span class="string">"$exists"</span>: <span class="keyword">False</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="2-3-更新数据"><a href="#2-3-更新数据" class="headerlink" title="2.3 更新数据"></a>2.3 更新数据</h3><p>MongoDB提供了一系列的操作符来帮助完成文档数据更新，具体说明可查看链接：<a href="https://docs.mongodb.com/manual/reference/operator/update/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/reference/operator/update/</a></p>
<h4 id="2-3-1-更新单个文档"><a href="#2-3-1-更新单个文档" class="headerlink" title="2.3.1 更新单个文档"></a>2.3.1 更新单个文档</h4><p>使用pymongo的<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.update_one" target="_blank" rel="noopener">update_one</a>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update_one(</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"paper"</span>&#125;, <span class="comment"># filter筛选条件, 只更新符合该条件的第一条数据</span></span><br><span class="line">    &#123;<span class="string">"$set"</span>: &#123;<span class="string">"size.uom"</span>: <span class="string">"cm"</span>, <span class="string">"status"</span>: <span class="string">"P"</span>&#125;,</span><br><span class="line">     <span class="string">"$currentDate"</span>: &#123;<span class="string">"lastModified"</span>: <span class="keyword">True</span>&#125;&#125;) <span class="comment"># 数据更新表达式，使用$set操作符来更新数据</span></span><br></pre></td></tr></table></figure>
<h4 id="2-3-2-更新多个文档"><a href="#2-3-2-更新多个文档" class="headerlink" title="2.3.2 更新多个文档"></a>2.3.2 更新多个文档</h4><p>使用pymongo的<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.update_many" target="_blank" rel="noopener">update_many()</a>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.update_many(</span><br><span class="line">    &#123;<span class="string">"qty"</span>: &#123;<span class="string">"$lt"</span>: <span class="number">50</span>&#125;&#125;, <span class="comment"># filter筛选条件，更新符合该条件的所有数据</span></span><br><span class="line">    &#123;<span class="string">"$set"</span>: &#123;<span class="string">"size.uom"</span>: <span class="string">"in"</span>, <span class="string">"status"</span>: <span class="string">"P"</span>&#125;,</span><br><span class="line">     <span class="string">"$currentDate"</span>: &#123;<span class="string">"lastModified"</span>: <span class="keyword">True</span>&#125;&#125;)<span class="comment"># 数据更新表达式，同样使用$set操作符来更新数据</span></span><br></pre></td></tr></table></figure>
<h4 id="2-3-3-替换文档"><a href="#2-3-3-替换文档" class="headerlink" title="2.3.3 替换文档"></a>2.3.3 替换文档</h4><p>使用pymongo的<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.replace_one" target="_blank" rel="noopener">replace()</a>方法</p>
<p>注：替换方法只替换除_id以外的其他字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.replace_one(</span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"paper"</span>&#125;, <span class="comment"># filter筛选条件，替换符合该条件的第一条数据</span></span><br><span class="line">    &#123;<span class="string">"item"</span>: <span class="string">"paper"</span>, <span class="comment"># 替换后的文档数据</span></span><br><span class="line">     <span class="string">"instock"</span>: [</span><br><span class="line">         &#123;<span class="string">"warehouse"</span>: <span class="string">"A"</span>, <span class="string">"qty"</span>: <span class="number">60</span>&#125;,</span><br><span class="line">         &#123;<span class="string">"warehouse"</span>: <span class="string">"B"</span>, <span class="string">"qty"</span>: <span class="number">40</span>&#125;]&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="2-3-4-upsert选项"><a href="#2-3-4-upsert选项" class="headerlink" title="2.3.4 upsert选项"></a>2.3.4 upsert选项</h4><p>不论是update_one()方法还是update_many()方法，亦或是replace_one()方法，都包含upsert:bool 选项，当upsert为True时，这些方法将具备在filter未筛选到文档时，执行文档插入的能力。</p>
<h3 id="2-4-删除数据"><a href="#2-4-删除数据" class="headerlink" title="2.4 删除数据"></a>2.4 删除数据</h3><p>pymongo提供了<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.delete_one" target="_blank" rel="noopener">delete_one()</a>和<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.delete_many" target="_blank" rel="noopener">delete_many()</a>两种方法执行删除操作。其中，delete_one()方法一次执行一条文档的删除任务，delete_manyI()可执行多条文档删除任务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.delete_one(&#123;<span class="string">"status"</span>: <span class="string">"D"</span>&#125;) <span class="comment"># 删除符合status值为D的第一条数据</span></span><br><span class="line">db.inventory.delete_many(&#123;<span class="string">"status"</span>: <span class="string">"A"</span>&#125;) <span class="comment"># 删除符合status值为A的所有数据</span></span><br></pre></td></tr></table></figure>
<p>值得一提的是，删除操作并不会改变collection的索引设置，即便删除了这个collection下的所有文档。</p>
<h3 id="2-5-批量写入"><a href="#2-5-批量写入" class="headerlink" title="2.5 批量写入"></a>2.5 批量写入</h3><p>pymongo提供了批量写入方法：<a href="https://api.mongodb.com/python/current/api/pymongo/collection.html#pymongo.collection.Collection.bulk_write" target="_blank" rel="noopener">bulk_write()</a>，类似于redis中的pipe_line，它可以将多个写入操作作为一个list参数传入，然后一起执行。它支持insert、update、replace、delete的多种方法，以下是官方文档提供的示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   db.characters.bulkWrite(</span><br><span class="line">      [</span><br><span class="line">         &#123; insertOne :</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="string">"document"</span> :</span><br><span class="line">               &#123;</span><br><span class="line">                  <span class="string">"_id"</span> : <span class="number">4</span>, <span class="string">"char"</span> : <span class="string">"Dithras"</span>, <span class="string">"class"</span> : <span class="string">"barbarian"</span>, <span class="string">"lvl"</span> : <span class="number">4</span></span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123; insertOne :</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="string">"document"</span> :</span><br><span class="line">               &#123;</span><br><span class="line">                  <span class="string">"_id"</span> : <span class="number">5</span>, <span class="string">"char"</span> : <span class="string">"Taeln"</span>, <span class="string">"class"</span> : <span class="string">"fighter"</span>, <span class="string">"lvl"</span> : <span class="number">3</span></span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123; updateOne :</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="string">"filter"</span> : &#123; <span class="string">"char"</span> : <span class="string">"Eldon"</span> &#125;,</span><br><span class="line">               <span class="string">"update"</span> : &#123; $set : &#123; <span class="string">"status"</span> : <span class="string">"Critical Injury"</span> &#125; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123; deleteOne :</span><br><span class="line">            &#123; <span class="string">"filter"</span> : &#123; <span class="string">"char"</span> : <span class="string">"Brisbane"</span>&#125; &#125;</span><br><span class="line">         &#125;,</span><br><span class="line">         &#123; replaceOne :</span><br><span class="line">            &#123;</span><br><span class="line">               <span class="string">"filter"</span> : &#123; <span class="string">"char"</span> : <span class="string">"Meldane"</span> &#125;,</span><br><span class="line">               <span class="string">"replacement"</span> : &#123; <span class="string">"char"</span> : <span class="string">"Tanys"</span>, <span class="string">"class"</span> : <span class="string">"oracle"</span>, <span class="string">"lvl"</span> : <span class="number">4</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   );</span><br><span class="line">&#125;</span><br><span class="line">catch (e) &#123;</span><br><span class="line">   print(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-数据模型"><a href="#3-数据模型" class="headerlink" title="3. 数据模型"></a>3. 数据模型</h2><h3 id="3-1-基础知识"><a href="#3-1-基础知识" class="headerlink" title="3.1 基础知识"></a>3.1 基础知识</h3><h4 id="3-1-1-灵活的模式"><a href="#3-1-1-灵活的模式" class="headerlink" title="3.1.1 灵活的模式"></a>3.1.1 灵活的模式</h4><p>1）同一个集合下，不同文档的字段可以不一致；同一个集合下，不同文档的相同字段，类型可以不一致；<br>2）可以通过对一个文档的字段进行增删改操作，或是变更字段类型，来改变文档的结构。</p>
<h4 id="3-1-2-文档结构"><a href="#3-1-2-文档结构" class="headerlink" title="3.1.2 文档结构"></a>3.1.2 文档结构</h4><p>1) <strong>嵌入式文档结构</strong>，即在一个文档内，可以嵌套子文档内容，实现逻辑相关的数据结构嵌套组合。嵌套式文档结构如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户信息表</span></span><br><span class="line">&#123;</span><br><span class="line">    _id: ObjectId_1,</span><br><span class="line">    username: <span class="string">"youjia"</span>,</span><br><span class="line">    sex: <span class="string">"man"</span>,</span><br><span class="line">    age: <span class="number">29</span>,</span><br><span class="line">    contact: &#123; <span class="comment"># 嵌入式文档</span></span><br><span class="line">        phone: <span class="number">18195181469</span>,</span><br><span class="line">        email: <span class="string">"jia.you@shunwang.com"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2) <strong>引用式</strong>，不同类型数据使用id引用进行关联，上例可变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户表</span></span><br><span class="line">&#123;</span><br><span class="line">    _id: ObjectId_1,</span><br><span class="line">    username: <span class="string">"youjia"</span>,</span><br><span class="line">    sex: <span class="string">"man"</span>,</span><br><span class="line">    age: <span class="number">29</span>,</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 联系信息表（原嵌入式文档）</span></span><br><span class="line">&#123;</span><br><span class="line">    _id: ObjectId_2,</span><br><span class="line">    user_id: ObjectId_1, <span class="comment"># 对应用户表_id</span></span><br><span class="line">    phone: <span class="number">18195181469</span>,</span><br><span class="line">    email: <span class="string">"jia.you@shunwang.com"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-1-3-原子性的写入操作"><a href="#3-1-3-原子性的写入操作" class="headerlink" title="3.1.3 原子性的写入操作"></a>3.1.3 原子性的写入操作</h4><p>1) 对一个文档的写入操作是原子性的，即使这个写入操作包含了对嵌套文档的数据写入。<br>2) 由于对嵌套文档的写入动作是原子性的，因此嵌套式的文档结构设计，更加促进了写入操作原子化，提高了写入效率和数据一致性。<br>3) 当执行类似updateMany等操作时，虽然只执行了一条指令，但其内部执行过程实际上包含了对多个文档的原子操作。因此这类批量执行指令是非原子性的。<br>4) 由于对多个文档的批量指令执行是非原子性的，因此在对多个文档进行写入操作时，写入任务可能与其他批量写入任务交叉。<br>5) 从MongoDB4.0开始，为了保证多文档写入/读取数据的一致性，加入了<a href="https://docs.mongodb.com/manual/core/transactions/" target="_blank" rel="noopener">多表操作事务</a><br>6) 多表操作事务相比单表操作，会造成大的多的性能消耗，因此官方仍然认为，在多数情况下 <strong>嵌入式文档结构是更好的选择</strong>。</p>
<h4 id="3-1-4-数据模型校验"><a href="#3-1-4-数据模型校验" class="headerlink" title="3.1.4 数据模型校验"></a>3.1.4 数据模型校验</h4><p>官方提供了多种数据模型校验的方法，包括：1. JSON Schema校验，2. 查询表达式校验。官方推荐使用前者。<br>一个典型的JSON Schema语法示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection("students", &#123;</span><br><span class="line">   validator: &#123;</span><br><span class="line">      $jsonSchema: &#123;</span><br><span class="line">         bsonType: "object",</span><br><span class="line">         required: [ "name", "year", "major", "gpa" ],</span><br><span class="line">         properties: &#123;</span><br><span class="line">            name: &#123;</span><br><span class="line">               bsonType: "string",</span><br><span class="line">               description: "must be a string and is required"</span><br><span class="line">            &#125;,</span><br><span class="line">            gender: &#123;</span><br><span class="line">               bsonType: "string",</span><br><span class="line">               description: "must be a string and is not required"</span><br><span class="line">            &#125;,</span><br><span class="line">            year: &#123;</span><br><span class="line">               bsonType: "int",</span><br><span class="line">               minimum: 2017,</span><br><span class="line">               maximum: 3017,</span><br><span class="line">               exclusiveMaximum: false,</span><br><span class="line">               description: "must be an integer in [ 2017, 3017 ] and is required"</span><br><span class="line">            &#125;,</span><br><span class="line">            major: &#123;</span><br><span class="line">               enum: [ "Math", "English", "Computer Science", "History", null ],</span><br><span class="line">               description: "can only be one of the enum values and is required"</span><br><span class="line">            &#125;,</span><br><span class="line">            gpa: &#123;</span><br><span class="line">               bsonType: [ "double" ],</span><br><span class="line">               minimum: 0,</span><br><span class="line">               description: "must be a double and is required"</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>关于JSON Schema的更详细信息，可参照网上教程：<a href="https://spacetelescope.github.io/understanding-json-schema/" target="_blank" rel="noopener">https://spacetelescope.github.io/understanding-json-schema/</a></p>
<h3 id="3-2-模型设计原则"><a href="#3-2-模型设计原则" class="headerlink" title="3.2 模型设计原则"></a>3.2 模型设计原则</h3><h4 id="3-2-1-设计原则概述"><a href="#3-2-1-设计原则概述" class="headerlink" title="3.2.1 设计原则概述"></a>3.2.1 设计原则概述</h4><p>3.1.1中介绍了模型的两种设计结构：<strong>嵌入式文档结构</strong>，和 <strong>引用式</strong> 文档结构。在设计数据模型时，要考虑根据不同情况选择适合的文档结构进行设计。</p>
<h5 id="3-2-1-1-选择嵌套式文档结构"><a href="#3-2-1-1-选择嵌套式文档结构" class="headerlink" title="3.2.1.1 选择嵌套式文档结构"></a>3.2.1.1 选择嵌套式文档结构</h5><p>以下情况下适合使用嵌入式文档结构：</p>
<p>1) 两类数据是一对一并且具有包含关系。例如：用户个人信息-用户联系信息<br>2) 两类数据时一对多关系，但是在应用过程中通常两类数据需要联合查询使用，使用“一”时通常会查询“多”。</p>
<ul>
<li>嵌套式文档结构的优点：<ul>
<li>嵌套式文档结构提供了更好的读性能，数据查询可在一个集合内完成而不必跨集合查询。</li>
<li>降低了数据写入消耗，数据不必多文档写入，一次数据写入任务可以在一个文档内完成，仅执行一次原子性操作。</li>
</ul>
</li>
</ul>
<p>注意：MongoDB默认限制单个文档大小最大为16MB，因此单个文档大小不能无限扩大。Mongo提供了其他大体量数据的存储方式：<a href="https://docs.mongodb.com/manual/core/gridfs/" target="_blank" rel="noopener">GridFS</a></p>
<h5 id="3-2-1-2-选择引用式文档结构"><a href="#3-2-1-2-选择引用式文档结构" class="headerlink" title="3.2.1.2 选择引用式文档结构"></a>3.2.1.2 选择引用式文档结构</h5><p>以下情况适合使用引用式文档结构：</p>
<p>1) 当采用嵌套式文档结构时，被嵌套的数据会有大量重复，并且大量重复数据造成影响大于嵌套文档的优势时，选择引用式文档结构时更好的选择。<br>2) 要设计“多对多”关系时。<br>3) 为大型分层数据集建模时。</p>
<ul>
<li>引用式文档的优点：<ul>
<li>相比嵌套式结构，多组数据的关系更加解耦。</li>
<li>更适应多对多的关系场景。</li>
</ul>
</li>
</ul>
<h5 id="3-2-1-3-模型设计中的其他考虑因素"><a href="#3-2-1-3-模型设计中的其他考虑因素" class="headerlink" title="3.2.1.3 模型设计中的其他考虑因素"></a>3.2.1.3 模型设计中的其他考虑因素</h5><ul>
<li>原子性操作数量是影响数据库操作性能的主要因素之一，多数情况下，嵌入式文档结构可以有效降低数据库操作成本，提高性能。</li>
<li>多文档引用关系下的跨文档操作，会提高操作成本。</li>
<li>多文档数据操作，涉及到读写数据一致性问题，需要用到事务(4.0以后版本)。事务的使用会带来明显的性能消耗。</li>
<li>对读操作较多的文档设置索引可以提升查询性能，索引设置在查询较多的字段上，主键_id默认设置了索引。</li>
<li>索引对写操作的性能有影响。</li>
<li>索引会占用一定的数据空间，影响内存和磁盘的空间使用。</li>
<li>单个文档存储的数据量过大时，会影响数据库操作请求往返的时间和带宽消耗。</li>
<li>单个文档不要超过16MB，过于小的文档模型会浪费存储空间。</li>
<li>小文档可以通过缩短filed名称长度来降低存储空间消耗。</li>
<li>对于没有持久化需求的数据，可以设置集合属性为“限制集合capped collection”来控制集合大小。</li>
</ul>
<h2 id="4-索引"><a href="#4-索引" class="headerlink" title="4. 索引"></a>4. 索引</h2><p>对于查询需求较多的文档，可以通过在适合的字段建立索引来提高查询效率。但是对文档建立过多的索引，会影响写入效率，增加磁盘和内存的空间使用率。</p>
<h3 id="4-1-索引类型"><a href="#4-1-索引类型" class="headerlink" title="4.1 索引类型"></a>4.1 索引类型</h3><h4 id="4-1-1-单字段索引"><a href="#4-1-1-单字段索引" class="headerlink" title="4.1.1 单字段索引"></a>4.1.1 单字段索引</h4><p>对文档内单个字段建立索引，称为单字段索引。适合对文档内单个字段有频繁查询请求的场景。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.person.createIndex( &#123;id_no: 1&#125; )</span><br></pre></td></tr></table></figure>
<p>{id_no: 1}代表升序索引，{id_no: -1}代表降序索引，在单字段索引类型下，升序与降序没有区别。</p>
<h4 id="4-1-2-复合索引"><a href="#4-1-2-复合索引" class="headerlink" title="4.1.2 复合索引"></a>4.1.2 复合索引</h4><p>复合索引是对多个字段联合创建一个索引。适合对文档内某些字段有频繁查询请求，以及查询与排序请求并存的业务场景。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.person.createIndex( &#123;age: 1, name: 1&#125; )</span><br></pre></td></tr></table></figure>
<p>创建符合索引时，field的顺序是有关系的。索引将按照第一个field进行升序/降序排列，在此基础上，再对第二个field进行升序/降序排列，以此类推。</p>
<h4 id="4-1-3-多key索引"><a href="#4-1-3-多key索引" class="headerlink" title="4.1.3 多key索引"></a>4.1.3 多key索引</h4><p>当索引的字段为数组时，创建出的索引称为多key索引，多key索引会为数组的每个元素建立一条索引，比如person表加入一个habbit字段（数组）用于描述兴趣爱好，需要查询有相同兴趣爱好的人就可以利用habbit字段的多key索引。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//文档格式</span><br><span class="line">&#123;"name" : "jack", "age" : 19, habbit: ["football, runnning"]&#125;</span><br><span class="line"></span><br><span class="line">// 自动创建多key索引</span><br><span class="line">db.person.createIndex( &#123;habbit: 1&#125; )  </span><br><span class="line">db.person.find( &#123;habbit: "football"&#125; )</span><br></pre></td></tr></table></figure>
<h3 id="4-2-索引属性"><a href="#4-2-索引属性" class="headerlink" title="4.2 索引属性"></a>4.2 索引属性</h3><h4 id="4-2-1-唯一索引"><a href="#4-2-1-唯一索引" class="headerlink" title="4.2.1 唯一索引"></a>4.2.1 唯一索引</h4><p>保证索引对应的字段不会出现相同的值，文档主键_id的索引，就是唯一索引。</p>
<h4 id="4-2-2-TTL索引"><a href="#4-2-2-TTL索引" class="headerlink" title="4.2.2 TTL索引"></a>4.2.2 TTL索引</h4><p>可以针对某个时间字段，指定文档的过期时间（经过指定时间后过期 或 在某个时间点过期）</p>
<h4 id="4-2-3-部分索引"><a href="#4-2-3-部分索引" class="headerlink" title="4.2.3 部分索引"></a>4.2.3 部分索引</h4><p>只针对符合某个特定条件的文档建立索引，比如某字段值大于5，或者某字段值符合某正则表达式，才建立索引，注意：3.2版本才支持该特性.</p>
<h4 id="4-2-4-稀疏索引"><a href="#4-2-4-稀疏索引" class="headerlink" title="4.2.4 稀疏索引"></a>4.2.4 稀疏索引</h4><p>只针对存在索引字段的文档建立索引，可看做是部分索引的一种特殊情况</p>
<h3 id="4-3-索引使用注意事项"><a href="#4-3-索引使用注意事项" class="headerlink" title="4.3 索引使用注意事项"></a>4.3 索引使用注意事项</h3><h4 id="4-3-1-创建索引"><a href="#4-3-1-创建索引" class="headerlink" title="4.3.1 创建索引"></a>4.3.1 创建索引</h4><ul>
<li>选择查询需求较多的文档创建索引；</li>
<li>文档中索引创建数量不宜过多，过多的索引会影响写入速度，占用磁盘和内存空间。</li>
<li>根据查询场景，选择合适的索引类型。</li>
<li>在已填满数据的集合里创建索引，要设置background选项为True，否则在创建过程中会阻塞所有对该集合的读写请求，直至索引创建完成。因此在已有数据的集合内创建索引时，要谨慎。</li>
</ul>
<h4 id="4-3-2-选择合适的索引"><a href="#4-3-2-选择合适的索引" class="headerlink" title="4.3.2 选择合适的索引"></a>4.3.2 选择合适的索引</h4><ul>
<li><p>单字段索引</p>
<ul>
<li>对文档内的某个字段有频繁的查询需求</li>
<li>对文档内的某个字段有频繁的排序需求</li>
<li>单字段索引创建，可以不关心索引是升序还是降序的，这对单字段索引没有影响</li>
<li>可以通过“点标法”对文档的内嵌文档中的字段建立索引</li>
</ul>
</li>
<li><p>复合索引</p>
<ul>
<li>对文档内的某些字段有频繁的查询需求，并且查询需求通常是针对多个字段同时进行的</li>
<li>对文档内的某些字段同时有查询和排序需求，并且查询排序需求通常是同时针对多个字段进行的</li>
<li>创建复合索引时，需根据查询场景选择各字段的索引是升序还是降序。例如：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建索引</span></span><br><span class="line">db.collection.create_index( &#123; <span class="string">"x"</span> : <span class="number">1</span>, <span class="string">"y"</span> : <span class="number">-1</span> &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持下列查询/排序</span></span><br><span class="line">db.collection.find().sort( &#123; <span class="string">"x"</span>: <span class="number">1</span>, <span class="string">"y"</span>: <span class="number">-1</span> &#125; )</span><br><span class="line">db.collection.find().sort( &#123; <span class="string">"x"</span>: <span class="number">-1</span>, <span class="string">"y"</span>: <span class="number">1</span> &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对下列查询/排序，索引不生效</span></span><br><span class="line">db.collection.find().sort( &#123; <span class="string">"x"</span>: <span class="number">1</span>, <span class="string">"y"</span>: <span class="number">1</span> &#125; )</span><br></pre></td></tr></table></figure>
<ul>
<li>根据业务场景需求，选择合适的索引前缀（字段索引顺序），后缀的索引是在前缀索引的基础上建立的。前缀索引可以作为单独的索引字段查询，但是后缀的索引不可以这样应用。例如：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建索引</span></span><br><span class="line">db.collection.create_index( &#123; <span class="string">"x"</span> : <span class="number">1</span>, <span class="string">"y"</span> : <span class="number">1</span> , <span class="string">"z"</span>: <span class="number">1</span>&#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持对下列查询/排序场景</span></span><br><span class="line">db.collection.find().sort(&#123;<span class="string">"x"</span>: <span class="number">1</span>&#125;)</span><br><span class="line">db.collection.find().sort(&#123;<span class="string">"x"</span>: <span class="number">1</span>, <span class="string">"y"</span>: <span class="number">1</span>&#125;)</span><br><span class="line">db.collection.find().sort(&#123;<span class="string">"x"</span>: <span class="number">1</span>, <span class="string">"z"</span>: <span class="number">1</span>&#125;) <span class="comment"># 效率较低</span></span><br><span class="line">db.collection.find().sort(&#123;<span class="string">"x"</span>: <span class="number">1</span>, <span class="string">"y"</span>: <span class="number">1</span>, <span class="string">"z"</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不支持下列查询/排序场景</span></span><br><span class="line">db.collection.find().sort(&#123;<span class="string">"y"</span>: <span class="number">1</span>&#125;)</span><br><span class="line">db.collection.find().sort(&#123;<span class="string">"z"</span>: <span class="number">1</span>&#125;)</span><br><span class="line">db.collection.find().sort(&#123;<span class="string">"y"</span>: <span class="number">1</span>, <span class="string">"z"</span>: <span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>多key索引</p>
<ul>
<li>针对数组类型的field创建索引，即为多key索引，创建方式与单key索引一样，当field的数组元素为内嵌文档时，可以对内嵌文档的字段建立多key索引。</li>
<li>一个文档只允许存在一个多key索引。当此文档存在多个array类型的field时，只能针对其中一个field建立多key索引。</li>
<li>复合索引中，可以允许一个文档下存在一个多key索引，而不要求一定是某个field。例如：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建复合索引</span></span><br><span class="line">db.collection.create_index( &#123; <span class="string">"x"</span> : <span class="number">1</span>, <span class="string">"y"</span> : <span class="number">1</span> &#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 索引支持的文档</span></span><br><span class="line">&#123; <span class="string">"x"</span> : <span class="number">1</span>, <span class="string">"y"</span> : [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] &#125;</span><br><span class="line">&#123;<span class="string">"x"</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], <span class="string">"y"</span>: <span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不支持的情况</span></span><br><span class="line">&#123;<span class="string">"x"</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], <span class="string">"y"</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以对array内的嵌入式文档的某个field建立索引。例如：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文档结构</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"x"</span>: <span class="string">"test"</span>,</span><br><span class="line">    <span class="string">"y"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"z"</span>: [</span><br><span class="line">        &#123;<span class="string">"a"</span>: <span class="number">1</span>, <span class="string">"b"</span>: <span class="string">"test"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">"a"</span>: <span class="number">2</span>, <span class="string">"b"</span>: <span class="string">"some"</span>&#125;,</span><br><span class="line">        ...</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立嵌入式文档的多key索引</span></span><br><span class="line">db.collection_name.create_index(&#123;<span class="string">"z.a"</span>: <span class="number">1</span>, <span class="string">"z.b"</span>: <span class="number">-1</span>&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/08/10/MongoDB-Knowledge-Point-For-Developers/" data-id="cjknrbgh000012kqa854eakqg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MongoDb-Python-developers/">MongoDb Python developers</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/20/hello-world/" class="article-date">
  <time datetime="2018-06-20T04:39:39.426Z" itemprop="datePublished">2018-06-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/20/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/20/hello-world/" data-id="cjknrbggv00002kqagzoiixzc" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDb-Python-developers/">MongoDb Python developers</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MongoDb-Python-developers/" style="font-size: 10px;">MongoDb Python developers</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/08/10/MongoDB-Knowledge-Point-For-Developers/">MongoDB Knowledge Point For Developers</a>
          </li>
        
          <li>
            <a href="/2018/06/20/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Arvin<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>